# ==============================================================================
# Self-Hosted Docker Registry
# ==============================================================================
# Private Docker registry with:
#   - Traefik integration for SSL/TLS
#   - Basic authentication via htpasswd
#   - Persistent storage for images
#
# Access at: https://registry.${DOMAIN}
#
# Usage:
#   docker login registry.yourdomain.com
#   docker push registry.yourdomain.com/myapp:latest
# ==============================================================================

services:
  registry:
    image: registry:2
    container_name: registry
    restart: unless-stopped
    env_file:
      - path: ../config.env
        required: true
      - path: ../config.env.local
        required: false
    volumes:
      - registry_data:/var/lib/registry
      - ./auth:/auth:ro
    environment:
      # Authentication
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: "Docker Registry"
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      # Storage
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      # Optional: Enable garbage collection
      # REGISTRY_STORAGE_MAINTENANCE_UPLOADPURGING_ENABLED: "true"
    labels:
      - "traefik.enable=true"
      # Router configuration
      - "traefik.http.routers.registry.rule=Host(`${REGISTRY_DOMAIN:-registry.${DEFAULT_DOMAIN:-localhost}}`)"
      - "traefik.http.routers.registry.tls.certresolver=letsencrypt"
      - "traefik.http.routers.registry.entrypoints=websecure"
      # Service configuration
      - "traefik.http.services.registry.loadbalancer.server.port=5000"
      # Security headers
      - "traefik.http.middlewares.registry-headers.headers.customrequestheaders.Docker-Distribution-Api-Version=registry/2.0"
      - "traefik.http.routers.registry.middlewares=registry-headers"
    networks:
      - web
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget --no-verbose --tries=1 --spider http://localhost:5000/ || exit 0",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  registry_data:
    name: registry_data

networks:
  web:
    external: true
